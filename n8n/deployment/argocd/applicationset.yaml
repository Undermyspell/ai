apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: zumba-stack
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  
  generators:
  - list:
      elements:
      # Staging environment
      - env: staging
        namespace: zumba-staging
      # Production environment
      - env: production
        namespace: zumba-production
  
  template:
    metadata:
      name: zumba-{{.env}}
      labels:
        app.kubernetes.io/name: zumba-stack
        app.kubernetes.io/instance: zumba-{{.env}}
        app.kubernetes.io/managed-by: argocd
    spec:
      project: default
      
      # Multi-source deployment:
      # 1. Helm chart for main application (n8n + PostgreSQL)
      # 2. Kustomize for SealedSecrets and labels
      sources:
      
      # Source 1: Helm chart with environment-specific values
      # Uses Kustomize post-renderer to apply labels
      - repoURL: https://github.com/Undermyspell/ai.git
        targetRevision: HEAD
        path: n8n/deployment/helm-charts/zumba
        helm:
          releaseName: zumba
          valueFiles:
          - ../../environments/{{.env}}/values.yaml
          # Post-render with Kustomize to apply labels
          postRenderers:
          - kustomize:
              path: ../../environments/{{.env}}/post-render
      
      # Source 2: SealedSecrets via Kustomize (includes common-labels component)
      - repoURL: https://github.com/Undermyspell/ai.git 
        targetRevision: HEAD
        path: n8n/deployment/environments/{{.env}}
      
      destination:
        server: https://kubernetes.default.svc
        namespace: "{{.namespace}}"
      
      syncPolicy:
        automated:
          prune: true      # Remove resources that are no longer defined in git
          selfHeal: true   # Automatically sync when cluster state differs from git
        syncOptions:
        - CreateNamespace=true           # Auto-create namespace if it doesn't exist
        - ServerSideApply=true           # Use server-side apply for better conflict resolution
        - RespectIgnoreDifferences=true  # Respect ignoreDifferences configuration
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
